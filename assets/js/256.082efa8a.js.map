{"version":3,"sources":["webpack:///./docs/cache-pdp/053.md","webpack:///./docs/cache-pdp/053.md?216d","webpack:///./docs/cache-pdp/053.md?ddc3"],"names":[],"mappings":";;;;;;;;;;AAAA;AAAA;AAAA;AAAiF;AACjF;;;AAGA;AAC0F;AAC1F,gBAAgB,2GAAU;AAC1B;AACA,EAAE,6EAAM;AACR,EAAE,sFAAe;AACjB;AACA;AACA;AACA;;AAEA;;AAEe,gF;;;;;;;;;;;;ACjBf;AAAA;AAAA;AAAA;AAAA;AAAA;;;;;;;;;;;;;ACAA;AAAA;AAAA;AAAA,0BAA0B,aAAa,0BAA0B,wBAAwB,qCAAqC,OAAO,gCAAgC,WAAW,OAAO,sDAAsD,UAAU,mCAAmC,yDAAyD,uJAAuJ,OAAO,4CAA4C,m4BAAm4B,8CAA8C,YAAY,gBAAgB,yBAAyB,wBAAwB,gBAAgB,oCAAoC,kEAAkE,gBAAgB,0BAA0B,0IAA0I,gBAAgB,0BAA0B,+IAA+I,mCAAmC,aAAa,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,qIAAqI,0CAA0C,YAAY,gBAAgB,yBAAyB,+NAA+N,uCAAuC,mfAAmf,4EAA4E,mNAAmN,mCAAmC,aAAa,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,qCAAqC,0BAA0B,gLAAgL,0CAA0C,YAAY,gBAAgB,yBAAyB,wSAAwS,mCAAmC,aAAa,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,mMAAmM,+BAA+B,UAAU,iCAAiC,gQAAgQ,0CAA0C,YAAY,gBAAgB,yBAAyB,6iBAA6iB,mCAAmC,aAAa,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B,oCAAoC,0BAA0B;AACriR","file":"assets/js/256.082efa8a.js","sourcesContent":["import { render, staticRenderFns } from \"./053.md?vue&type=template&id=7ddd79ee&\"\nvar script = {}\n\n\n/* normalize component */\nimport normalizer from \"!../../node_modules/vue-loader/lib/runtime/componentNormalizer.js\"\nvar component = normalizer(\n  script,\n  render,\n  staticRenderFns,\n  false,\n  null,\n  null,\n  null\n  \n)\n\nexport default component.exports","export * from \"-!../../node_modules/cache-loader/dist/cjs.js?{\\\"cacheDirectory\\\":\\\"node_modules/@vuepress/core/node_modules/.cache/vuepress\\\",\\\"cacheIdentifier\\\":\\\"2e9acca5-vue-loader-template\\\"}!../../node_modules/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../node_modules/vue-loader/lib/index.js??ref--1-1!../../node_modules/@vuepress/markdown-loader/index.js??ref--1-2!./053.md?vue&type=template&id=7ddd79ee&\"","var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('ContentSlotsDistributor',{attrs:{\"slot-key\":_vm.$parent.slotKey}},[_c('h1',{attrs:{\"id\":\"_053-部署分发层-nginx-以及基于-lua-完成基于商品-id-的定向流量分发策略\"}},[_c('a',{staticClass:\"header-anchor\",attrs:{\"href\":\"#_053-部署分发层-nginx-以及基于-lua-完成基于商品-id-的定向流量分发策略\"}},[_vm._v(\"#\")]),_vm._v(\" 053. 部署分发层 nginx 以及基于 lua 完成基于商品 id 的定向流量分发策略\")]),_vm._v(\" \"),_c('p',[_vm._v(\"eshop-03 上也需要搭建一个 应用层 nginx，\"),_c('RouterLink',{attrs:{\"to\":\"/cache-pdp/052.html#搭建另外一个应用层-nginx\"}},[_vm._v(\"参考上一章节\")])],1),_vm._v(\" \"),_c('p',[_vm._v(\"nginx 三台的作用：\")]),_vm._v(\" \"),_c('ul',[_c('li',[_vm._v(\"eshop-01：应用层\")]),_vm._v(\" \"),_c('li',[_vm._v(\"eshop-02：应用层\")]),_vm._v(\" \"),_c('li',[_vm._v(\"eshop-03：分发层\")])]),_vm._v(\" \"),_c('p',[_vm._v(\"在 eshop-cache03 中编写 lua 脚本，完成基于商品 id 的流量分发策略\")]),_vm._v(\" \"),_c('p',[_vm._v(\"这里简化业务逻辑，实际上在你的公司中，你可以随意根据自己的业务逻辑和场景，去制定自己的流量分发策略\")]),_vm._v(\" \"),_c('p',[_vm._v(\"步骤如下：\")]),_vm._v(\" \"),_c('ol',[_c('li',[_vm._v(\"获取请求参数，比如 productId\")]),_vm._v(\" \"),_c('li',[_vm._v(\"对 productId 进行 hash\")]),_vm._v(\" \"),_c('li',[_vm._v(\"hash 值对应用服务器数量取模，获取到一个应用服务器\")]),_vm._v(\" \"),_c('li',[_vm._v(\"利用 http 发送请求到应用层 nginx\")]),_vm._v(\" \"),_c('li',[_vm._v(\"获取响应后返回\")])]),_vm._v(\" \"),_c('p',[_vm._v(\"为了能分发看出来效果，我们把之前 hello 输出信息修改为自己的主机名，如 \"),_c('code',[_vm._v(\"hello world,eshop-cache03\")])]),_vm._v(\" \"),_c('p',[_vm._v(\"使用 lua 转发需要用到 lua 的 http 包，这里导入下\")]),_vm._v(\" \"),_c('div',{staticClass:\"language-bash line-numbers-mode\"},[_c('pre',{pre:true,attrs:{\"class\":\"language-bash\"}},[_c('code',[_c('span',{pre:true,attrs:{\"class\":\"token builtin class-name\"}},[_vm._v(\"cd\")]),_vm._v(\" /usr/hello/lualib/resty/\\n\"),_c('span',{pre:true,attrs:{\"class\":\"token function\"}},[_vm._v(\"wget\")]),_vm._v(\" https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http_headers.lua  \\n\"),_c('span',{pre:true,attrs:{\"class\":\"token function\"}},[_vm._v(\"wget\")]),_vm._v(\" https://raw.githubusercontent.com/pintsized/lua-resty-http/master/lib/resty/http.lua\\n\")])]),_vm._v(\" \"),_c('div',{staticClass:\"line-numbers-wrapper\"},[_c('span',{staticClass:\"line-number\"},[_vm._v(\"1\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"2\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"3\")]),_c('br')])]),_c('p',[_vm._v(\"脚本编写\")]),_vm._v(\" \"),_c('p',[_vm._v(\"/usr/hello/lua/hello.lua\")]),_vm._v(\" \"),_c('div',{staticClass:\"language- line-numbers-mode\"},[_c('pre',{pre:true,attrs:{\"class\":\"language-text\"}},[_c('code',[_vm._v(\"-- 拿一个地址来说明：http://eshop-cache03/lua?method=hello&productId=1\\n-- 获取问号后面的参数列表\\nlocal uri_args = ngx.req.get_uri_args()\\n-- 获取参数\\nlocal productId = uri_args[\\\"productId\\\"]\\n\\n-- 定义后端应用 ip\\nlocal host = {\\\"192.168.99.170\\\", \\\"192.168.99.171\\\"}\\n-- 对商品 id 取模并计算 hash 值\\nlocal hash = ngx.crc32_long(productId)\\nhash = (hash % 2) + 1  \\n-- 拼接 http 前缀\\nbackend = \\\"http://\\\"..host[hash]\\n\\n-- 获取到参数中的路径，比如你要访问 /hello，这个例子中是需要传递访问路径的\\nlocal method = uri_args[\\\"method\\\"]\\n-- 拼接具体的访问地址不带 host，如：/hello?productId=1\\nlocal requestBody = \\\"/\\\"..method..\\\"?productId=\\\"..productId\\n\\n-- 获取 http 包\\nlocal http = require(\\\"resty.http\\\")  \\nlocal httpc = http.new()  \\n\\n-- 访问，这里有疑问：万一有 cooke 这些脚本支持吗？会很麻烦吗？\\nlocal resp, err = httpc:request_uri(backend, {  \\n    method = \\\"GET\\\",  \\n    path = requestBody,\\n    keepalive=false\\n})\\n\\n-- 如果没有响应则输出一个 err 信息\\nif not resp then  \\n    ngx.say(\\\"request error :\\\", err)  \\n    return  \\nend\\n\\n-- 有响应测输出响应信息\\nngx.say(resp.body)  \\n\\n-- 关闭 http 客户端实例\\nhttpc:close()\\n\")])]),_vm._v(\" \"),_c('div',{staticClass:\"line-numbers-wrapper\"},[_c('span',{staticClass:\"line-number\"},[_vm._v(\"1\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"2\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"3\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"4\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"5\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"6\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"7\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"8\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"9\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"10\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"11\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"12\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"13\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"14\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"15\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"16\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"17\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"18\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"19\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"20\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"21\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"22\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"23\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"24\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"25\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"26\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"27\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"28\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"29\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"30\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"31\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"32\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"33\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"34\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"35\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"36\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"37\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"38\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"39\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"40\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"41\")]),_c('br')])]),_c('p',[_vm._v(\"刷新配置：\"),_c('code',[_vm._v(\"/usr/servers/nginx/sbin/nginx -s reload\")])]),_vm._v(\" \"),_c('p',[_vm._v(\"访问\")]),_vm._v(\" \"),_c('div',{staticClass:\"language- line-numbers-mode\"},[_c('pre',{pre:true,attrs:{\"class\":\"language-text\"}},[_c('code',[_vm._v(\"这里的意思是，访问 03 这台分发 nginx，但是需要告诉它我访问后端哪个服务路径\\n由于后端两个 nginx 都只有 /lua 这个请求路径，所以就访问了它\\nhttp://eshop-cache03/lua?method=lua&productId=1\\n页面输出：hello world,eshop-cache02\\n\\nhttp://eshop-cache03/lua?method=lua&productId=4\\n页面输出：hello world,eshop-cache01\\n\")])]),_vm._v(\" \"),_c('div',{staticClass:\"line-numbers-wrapper\"},[_c('span',{staticClass:\"line-number\"},[_vm._v(\"1\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"2\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"3\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"4\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"5\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"6\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"7\")]),_c('br')])]),_c('p',[_vm._v(\"基于商品 id 的定向流量分发策略的 lua 脚本就开发完了，而且也测试过了\")]),_vm._v(\" \"),_c('p',[_vm._v(\"我们就可以看到，如果你请求的是固定的某一个商品，那么就一定会将流量打到固定的一个应用 nginx 上面去\")]),_vm._v(\" \"),_c('div',{staticClass:\"custom-block tip\"},[_c('p',{staticClass:\"custom-block-title\"},[_vm._v(\"TIP\")]),_vm._v(\" \"),_c('p',[_vm._v(\"如果访问报错，可以查看 nginx 的错误日志：cat /usr/servers/nginx/logs/error.log\")])]),_vm._v(\" \"),_c('p',[_vm._v(\"一开始访问报错，看错误日志看到的，百度了下解决了在请求的时候增加了 \"),_c('code',[_vm._v(\"keepalive=false\")]),_vm._v(\" 参数\")]),_vm._v(\" \"),_c('div',{staticClass:\"language- line-numbers-mode\"},[_c('pre',{pre:true,attrs:{\"class\":\"language-text\"}},[_c('code',[_vm._v(\"2019/04/02 02:00:33 [error] 8451#0: *16 lua entry thread aborted: runtime error: /usr/hello/lualib/resty/http.lua:926: bad argument #2 to 'set_keepalive' (number expected, got nil)\\nstack traceback:\\ncoroutine 0:\\n\\t[C]: in function 'set_keepalive'\\n\\t/usr/hello/lualib/resty/http.lua:926: in function 'request_uri'\\n\\t/usr/hello/lua/hello.lua:25: in function </usr/hello/lua/hello.lua:1>, client: 192.168.99.111, server: _, request: \\\"GET /lua?method=lua&productId=1 HTTP/1.1\\\", host: \\\"eshop-cache03\\\"\\n\\n\")])]),_vm._v(\" \"),_c('div',{staticClass:\"line-numbers-wrapper\"},[_c('span',{staticClass:\"line-number\"},[_vm._v(\"1\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"2\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"3\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"4\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"5\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"6\")]),_c('br'),_c('span',{staticClass:\"line-number\"},[_vm._v(\"7\")]),_c('br')])])])}\nvar staticRenderFns = []\n\nexport { render, staticRenderFns }"],"sourceRoot":""}