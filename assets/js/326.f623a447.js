(window["webpackJsonp"] = window["webpackJsonp"] || []).push([[326],{

/***/ "./docs/cache-pdp/dr/174.md":
/*!**********************************!*\
  !*** ./docs/cache-pdp/dr/174.md ***!
  \**********************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony import */ var _174_md_vue_type_template_id_89906d0a___WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./174.md?vue&type=template&id=89906d0a& */ "./docs/cache-pdp/dr/174.md?vue&type=template&id=89906d0a&");
/* harmony import */ var _node_modules_vue_loader_lib_runtime_componentNormalizer_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../../node_modules/vue-loader/lib/runtime/componentNormalizer.js */ "./node_modules/vue-loader/lib/runtime/componentNormalizer.js");

var script = {}


/* normalize component */

var component = Object(_node_modules_vue_loader_lib_runtime_componentNormalizer_js__WEBPACK_IMPORTED_MODULE_1__["default"])(
  script,
  _174_md_vue_type_template_id_89906d0a___WEBPACK_IMPORTED_MODULE_0__["render"],
  _174_md_vue_type_template_id_89906d0a___WEBPACK_IMPORTED_MODULE_0__["staticRenderFns"],
  false,
  null,
  null,
  null
  
)

/* harmony default export */ __webpack_exports__["default"] = (component.exports);

/***/ }),

/***/ "./docs/cache-pdp/dr/174.md?vue&type=template&id=89906d0a&":
/*!*****************************************************************!*\
  !*** ./docs/cache-pdp/dr/174.md?vue&type=template&id=89906d0a& ***!
  \*****************************************************************/
/*! exports provided: render, staticRenderFns */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony import */ var _node_modules_cache_loader_dist_cjs_js_cacheDirectory_node_modules_vuepress_core_node_modules_cache_vuepress_cacheIdentifier_2e9acca5_vue_loader_template_node_modules_vue_loader_lib_loaders_templateLoader_js_vue_loader_options_node_modules_cache_loader_dist_cjs_js_ref_1_0_node_modules_vue_loader_lib_index_js_ref_1_1_node_modules_vuepress_markdown_loader_index_js_ref_1_2_174_md_vue_type_template_id_89906d0a___WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! -!../../../node_modules/cache-loader/dist/cjs.js?{"cacheDirectory":"node_modules/@vuepress/core/node_modules/.cache/vuepress","cacheIdentifier":"2e9acca5-vue-loader-template"}!../../../node_modules/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../../node_modules/vue-loader/lib??ref--1-1!../../../node_modules/@vuepress/markdown-loader??ref--1-2!./174.md?vue&type=template&id=89906d0a& */ "./node_modules/cache-loader/dist/cjs.js?{\"cacheDirectory\":\"node_modules/@vuepress/core/node_modules/.cache/vuepress\",\"cacheIdentifier\":\"2e9acca5-vue-loader-template\"}!./node_modules/vue-loader/lib/loaders/templateLoader.js?!./node_modules/cache-loader/dist/cjs.js?!./node_modules/vue-loader/lib/index.js?!./node_modules/@vuepress/markdown-loader/index.js?!./docs/cache-pdp/dr/174.md?vue&type=template&id=89906d0a&");
/* harmony reexport (safe) */ __webpack_require__.d(__webpack_exports__, "render", function() { return _node_modules_cache_loader_dist_cjs_js_cacheDirectory_node_modules_vuepress_core_node_modules_cache_vuepress_cacheIdentifier_2e9acca5_vue_loader_template_node_modules_vue_loader_lib_loaders_templateLoader_js_vue_loader_options_node_modules_cache_loader_dist_cjs_js_ref_1_0_node_modules_vue_loader_lib_index_js_ref_1_1_node_modules_vuepress_markdown_loader_index_js_ref_1_2_174_md_vue_type_template_id_89906d0a___WEBPACK_IMPORTED_MODULE_0__["render"]; });

/* harmony reexport (safe) */ __webpack_require__.d(__webpack_exports__, "staticRenderFns", function() { return _node_modules_cache_loader_dist_cjs_js_cacheDirectory_node_modules_vuepress_core_node_modules_cache_vuepress_cacheIdentifier_2e9acca5_vue_loader_template_node_modules_vue_loader_lib_loaders_templateLoader_js_vue_loader_options_node_modules_cache_loader_dist_cjs_js_ref_1_0_node_modules_vue_loader_lib_index_js_ref_1_1_node_modules_vuepress_markdown_loader_index_js_ref_1_2_174_md_vue_type_template_id_89906d0a___WEBPACK_IMPORTED_MODULE_0__["staticRenderFns"]; });



/***/ }),

/***/ "./node_modules/cache-loader/dist/cjs.js?{\"cacheDirectory\":\"node_modules/@vuepress/core/node_modules/.cache/vuepress\",\"cacheIdentifier\":\"2e9acca5-vue-loader-template\"}!./node_modules/vue-loader/lib/loaders/templateLoader.js?!./node_modules/cache-loader/dist/cjs.js?!./node_modules/vue-loader/lib/index.js?!./node_modules/@vuepress/markdown-loader/index.js?!./docs/cache-pdp/dr/174.md?vue&type=template&id=89906d0a&":
/*!*****************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/cache-loader/dist/cjs.js?{"cacheDirectory":"node_modules/@vuepress/core/node_modules/.cache/vuepress","cacheIdentifier":"2e9acca5-vue-loader-template"}!./node_modules/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!./node_modules/cache-loader/dist/cjs.js??ref--1-0!./node_modules/vue-loader/lib??ref--1-1!./node_modules/@vuepress/markdown-loader??ref--1-2!./docs/cache-pdp/dr/174.md?vue&type=template&id=89906d0a& ***!
  \*****************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/*! exports provided: render, staticRenderFns */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "render", function() { return render; });
/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "staticRenderFns", function() { return staticRenderFns; });
var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('ContentSlotsDistributor',{attrs:{"slot-key":_vm.$parent.slotKey}},[_c('h1',{attrs:{"id":"_174-商品详情页动态渲染系统-完成应用层-nginx-的-lua-脚本的编写与部署"}},[_c('a',{staticClass:"header-anchor",attrs:{"href":"#_174-商品详情页动态渲染系统-完成应用层-nginx-的-lua-脚本的编写与部署"}},[_vm._v("#")]),_vm._v(" 174. 商品详情页动态渲染系统：完成应用层 nginx 的 lua 脚本的编写与部署")]),_vm._v(" "),_c('p',[_vm._v("同样这里也不实战了，与之前讲过的 "),_c('RouterLink',{attrs:{"to":"/cache-pdp/054.html"}},[_vm._v("多级缓存")]),_vm._v(" 知识点来看，只是多了一个 resty.redis 包的使用，\n使用 lua 直接连 redis 获取数据。")],1),_vm._v(" "),_c('div',{staticClass:"language- line-numbers-mode"},[_c('pre',{pre:true,attrs:{"class":"language-text"}},[_c('code',[_vm._v("local cjson = require(\"cjson\")\nlocal http = require(\"resty.http\")\nlocal redis = require(\"resty.redis\")  \n\nlocal function close_redis(red)  \n\tif not red then  \n\t\treturn  \n\tend  \n\tlocal pool_max_idle_time = 10000\n\tlocal pool_size = 100\n\tlocal ok, err = red:set_keepalive(pool_max_idle_time, pool_size)  \n\tif not ok then  \n\t\tngx.say(\"set keepalive error : \", err)  \n\tend  \nend\n\nlocal uri_args = ngx.req.get_uri_args()\nlocal productId = uri_args[\"productId\"]\n\nlocal cache_ngx = ngx.shared.my_cache\nlocal productCacheKey = \"product_\"..productId\n-- 从本地缓存获取商品信息\nlocal productCache = cache_ngx:get(productCacheKey)\n\n-- 如果本地缓存没有，则从 redis 中获取\nif productCache == \"\" or productCache == nil then\n  local red = redis:new()  \n  red:set_timeout(1000)  \n  local ip = \"192.168.31.223\"  \n  local port = 1112  \n  local ok, err = red:connect(ip, port)  \n  if not ok then  \n    ngx.say(\"connect to redis error : \", err)  \n    return close_redis(red)  \n  end\n\n  local redisResp, redisErr = red:get(\"dim_product_\"..productId)\n  -- 如果从 redis 中也获取不到数据，则直接从 数据直连服务获取（后面章节会讲解数据直连服务）\n  if redisResp == ngx.null then  \n    local httpc = http.new()\n    local resp, err = httpc:request_uri(\"http://192.168.31.179:8767\",{\n      method = \"GET\",\n      path = \"/product?productId=\"..productId\n    })\n\n    productCache = resp.body\n  end\n\n  productCache = redisResp\n\n  math.randomseed(tostring(os.time()):reverse():sub(1, 7))\n  local expireTime = math.random(600, 1200)  \n  -- 再延长时间放回本地缓存\n  cache_ngx:set(productCacheKey, productCache, expireTime)\nend\n\nlocal context = {\n  productInfo = productCache,\n}\n-- 通过模板渲染返回\nlocal template = require(\"resty.template\")\ntemplate.render(\"product.html\", context)\n\n")])]),_vm._v(" "),_c('div',{staticClass:"line-numbers-wrapper"},[_c('span',{staticClass:"line-number"},[_vm._v("1")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("2")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("3")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("4")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("5")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("6")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("7")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("8")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("9")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("10")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("11")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("12")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("13")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("14")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("15")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("16")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("17")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("18")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("19")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("20")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("21")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("22")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("23")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("24")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("25")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("26")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("27")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("28")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("29")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("30")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("31")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("32")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("33")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("34")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("35")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("36")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("37")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("38")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("39")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("40")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("41")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("42")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("43")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("44")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("45")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("46")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("47")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("48")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("49")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("50")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("51")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("52")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("53")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("54")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("55")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("56")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("57")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("58")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("59")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("60")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("61")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("62")]),_c('br'),_c('span',{staticClass:"line-number"},[_vm._v("63")]),_c('br')])]),_c('p',[_vm._v("这里的核心思路就是：如果 nginx local cache 没有，则通过 twemproxy 读本机房的从集群，\n如果还是没有，则发送 http 请求给数据直连服务")]),_vm._v(" "),_c('p',[_vm._v("视频中也只是写了这一个商品的多级缓存实现，品牌、分类数据也是一样的思路（视频中没有实现），\n模板也是使用的最简单的信息展示；")])])}
var staticRenderFns = []



/***/ })

}]);
//# sourceMappingURL=326.f623a447.js.map