(window["webpackJsonp"] = window["webpackJsonp"] || []).push([[360],{

/***/ "./docs/cache-pdp/redis/023.md":
/*!*************************************!*\
  !*** ./docs/cache-pdp/redis/023.md ***!
  \*************************************/
/*! exports provided: default */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony import */ var _023_md_vue_type_template_id_316354ae___WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./023.md?vue&type=template&id=316354ae& */ "./docs/cache-pdp/redis/023.md?vue&type=template&id=316354ae&");
/* harmony import */ var _node_modules_vue_loader_lib_runtime_componentNormalizer_js__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! ../../../node_modules/vue-loader/lib/runtime/componentNormalizer.js */ "./node_modules/vue-loader/lib/runtime/componentNormalizer.js");

var script = {}


/* normalize component */

var component = Object(_node_modules_vue_loader_lib_runtime_componentNormalizer_js__WEBPACK_IMPORTED_MODULE_1__["default"])(
  script,
  _023_md_vue_type_template_id_316354ae___WEBPACK_IMPORTED_MODULE_0__["render"],
  _023_md_vue_type_template_id_316354ae___WEBPACK_IMPORTED_MODULE_0__["staticRenderFns"],
  false,
  null,
  null,
  null
  
)

/* harmony default export */ __webpack_exports__["default"] = (component.exports);

/***/ }),

/***/ "./docs/cache-pdp/redis/023.md?vue&type=template&id=316354ae&":
/*!********************************************************************!*\
  !*** ./docs/cache-pdp/redis/023.md?vue&type=template&id=316354ae& ***!
  \********************************************************************/
/*! exports provided: render, staticRenderFns */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony import */ var _node_modules_cache_loader_dist_cjs_js_cacheDirectory_node_modules_vuepress_core_node_modules_cache_vuepress_cacheIdentifier_2e9acca5_vue_loader_template_node_modules_vue_loader_lib_loaders_templateLoader_js_vue_loader_options_node_modules_cache_loader_dist_cjs_js_ref_1_0_node_modules_vue_loader_lib_index_js_ref_1_1_node_modules_vuepress_markdown_loader_index_js_ref_1_2_023_md_vue_type_template_id_316354ae___WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! -!../../../node_modules/cache-loader/dist/cjs.js?{"cacheDirectory":"node_modules/@vuepress/core/node_modules/.cache/vuepress","cacheIdentifier":"2e9acca5-vue-loader-template"}!../../../node_modules/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!../../../node_modules/cache-loader/dist/cjs.js??ref--1-0!../../../node_modules/vue-loader/lib??ref--1-1!../../../node_modules/@vuepress/markdown-loader??ref--1-2!./023.md?vue&type=template&id=316354ae& */ "./node_modules/cache-loader/dist/cjs.js?{\"cacheDirectory\":\"node_modules/@vuepress/core/node_modules/.cache/vuepress\",\"cacheIdentifier\":\"2e9acca5-vue-loader-template\"}!./node_modules/vue-loader/lib/loaders/templateLoader.js?!./node_modules/cache-loader/dist/cjs.js?!./node_modules/vue-loader/lib/index.js?!./node_modules/@vuepress/markdown-loader/index.js?!./docs/cache-pdp/redis/023.md?vue&type=template&id=316354ae&");
/* harmony reexport (safe) */ __webpack_require__.d(__webpack_exports__, "render", function() { return _node_modules_cache_loader_dist_cjs_js_cacheDirectory_node_modules_vuepress_core_node_modules_cache_vuepress_cacheIdentifier_2e9acca5_vue_loader_template_node_modules_vue_loader_lib_loaders_templateLoader_js_vue_loader_options_node_modules_cache_loader_dist_cjs_js_ref_1_0_node_modules_vue_loader_lib_index_js_ref_1_1_node_modules_vuepress_markdown_loader_index_js_ref_1_2_023_md_vue_type_template_id_316354ae___WEBPACK_IMPORTED_MODULE_0__["render"]; });

/* harmony reexport (safe) */ __webpack_require__.d(__webpack_exports__, "staticRenderFns", function() { return _node_modules_cache_loader_dist_cjs_js_cacheDirectory_node_modules_vuepress_core_node_modules_cache_vuepress_cacheIdentifier_2e9acca5_vue_loader_template_node_modules_vue_loader_lib_loaders_templateLoader_js_vue_loader_options_node_modules_cache_loader_dist_cjs_js_ref_1_0_node_modules_vue_loader_lib_index_js_ref_1_1_node_modules_vuepress_markdown_loader_index_js_ref_1_2_023_md_vue_type_template_id_316354ae___WEBPACK_IMPORTED_MODULE_0__["staticRenderFns"]; });



/***/ }),

/***/ "./node_modules/cache-loader/dist/cjs.js?{\"cacheDirectory\":\"node_modules/@vuepress/core/node_modules/.cache/vuepress\",\"cacheIdentifier\":\"2e9acca5-vue-loader-template\"}!./node_modules/vue-loader/lib/loaders/templateLoader.js?!./node_modules/cache-loader/dist/cjs.js?!./node_modules/vue-loader/lib/index.js?!./node_modules/@vuepress/markdown-loader/index.js?!./docs/cache-pdp/redis/023.md?vue&type=template&id=316354ae&":
/*!********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************!*\
  !*** ./node_modules/cache-loader/dist/cjs.js?{"cacheDirectory":"node_modules/@vuepress/core/node_modules/.cache/vuepress","cacheIdentifier":"2e9acca5-vue-loader-template"}!./node_modules/vue-loader/lib/loaders/templateLoader.js??vue-loader-options!./node_modules/cache-loader/dist/cjs.js??ref--1-0!./node_modules/vue-loader/lib??ref--1-1!./node_modules/@vuepress/markdown-loader??ref--1-2!./docs/cache-pdp/redis/023.md?vue&type=template&id=316354ae& ***!
  \********************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************************/
/*! exports provided: render, staticRenderFns */
/***/ (function(module, __webpack_exports__, __webpack_require__) {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "render", function() { return render; });
/* harmony export (binding) */ __webpack_require__.d(__webpack_exports__, "staticRenderFns", function() { return staticRenderFns; });
var render = function () {var _vm=this;var _h=_vm.$createElement;var _c=_vm._self._c||_h;return _c('ContentSlotsDistributor',{attrs:{"slot-key":_vm.$parent.slotKey}},[_c('h1',{attrs:{"id":"_023-redis-哨兵的多个核心底层原理的深入解析-包含-slave-选举算法"}},[_c('a',{staticClass:"header-anchor",attrs:{"href":"#_023-redis-哨兵的多个核心底层原理的深入解析-包含-slave-选举算法"}},[_vm._v("#")]),_vm._v(" 023. redis 哨兵的多个核心底层原理的深入解析（包含 slave 选举算法）")]),_vm._v(" "),_c('p'),_c('div',{staticClass:"table-of-contents"},[_c('ul',[_c('li',[_c('a',{attrs:{"href":"#sdown-和-odown-转换机制"}},[_vm._v("sdown 和 odown 转换机制")])]),_c('li',[_c('a',{attrs:{"href":"#哨兵集群的自动发现机制"}},[_vm._v("哨兵集群的自动发现机制")])]),_c('li',[_c('a',{attrs:{"href":"#slave-配置的自动纠正"}},[_vm._v("slave 配置的自动纠正")])]),_c('li',[_c('a',{attrs:{"href":"#slave-master-选举算法"}},[_vm._v("slave->master 选举算法")])]),_c('li',[_c('a',{attrs:{"href":"#quorum-和-majority"}},[_vm._v("quorum 和 majority")])]),_c('li',[_c('a',{attrs:{"href":"#configuration-epoch"}},[_vm._v("configuration epoch")])]),_c('li',[_c('a',{attrs:{"href":"#configuraiton-传播"}},[_vm._v("configuraiton 传播")])])])]),_c('p'),_vm._v(" "),_c('h2',{attrs:{"id":"sdown-和-odown-转换机制"}},[_c('a',{staticClass:"header-anchor",attrs:{"href":"#sdown-和-odown-转换机制"}},[_vm._v("#")]),_vm._v(" sdown 和 odown 转换机制")]),_vm._v(" "),_c('p',[_vm._v("sdown 和 odown 是两种失败状态")]),_vm._v(" "),_c('ul',[_c('li',[_c('p',[_vm._v("sdown 是主观宕机")]),_vm._v(" "),_c('p',[_vm._v("一个哨兵如果自己觉得一个 master 宕机了，那么就是主观宕机")])]),_vm._v(" "),_c('li',[_c('p',[_vm._v("odown 是客观宕机\n如果 quorum 数量的哨兵都觉得一个 master 宕机了，那么就是客观宕机")])])]),_vm._v(" "),_c('p',[_vm._v("sdown 达成的条件很简单，如果一个哨兵 ping 一个 master，超过了 is-master-down-after-milliseconds（在哨兵配置文件中配置的） 指定的毫秒数之后，就主观认为 master 宕机")]),_vm._v(" "),_c('p',[_vm._v("sdown 到 odown 转换的条件很简单，如果一个哨兵在指定时间内，收到了 quorum 指定数量的其他哨兵也认为那个 master 是 sdown 了，那么就认为是 odown 了，客观认为 master 宕机")]),_vm._v(" "),_c('h2',{attrs:{"id":"哨兵集群的自动发现机制"}},[_c('a',{staticClass:"header-anchor",attrs:{"href":"#哨兵集群的自动发现机制"}},[_vm._v("#")]),_vm._v(" 哨兵集群的自动发现机制")]),_vm._v(" "),_c('p',[_vm._v("哨兵互相之间的发现，是通过 redis 的 pub/sub 系统实现的，每个哨兵都会往 "),_c('code',[_vm._v("__sentinel__:hello")]),_vm._v(" 这个 channel 里发送一个消息，这时候所有其他哨兵都可以消费到这个消息，并感知到其他的哨兵的存在")]),_vm._v(" "),_c('p',[_vm._v("每隔两秒钟，每个哨兵都会往自己监控的某个 master+slaves 对应的 "),_c('code',[_vm._v("__sentinel__:hello channel")]),_vm._v(" 里发送一个消息，内容是自己的 host、ip和 runid 还有对这个 master 的监控配置")]),_vm._v(" "),_c('p',[_vm._v("每个哨兵也会去监听自己监控的每个 master+slaves 对应的 "),_c('code',[_vm._v("__sentinel__:hello channel")]),_vm._v("，然后去感知到同样在监听这个 master+slaves 的其他哨兵的存在")]),_vm._v(" "),_c('p',[_vm._v("每个哨兵还会跟其他哨兵交换对 master 的监控配置，互相进行监控配置的同步")]),_vm._v(" "),_c('h2',{attrs:{"id":"slave-配置的自动纠正"}},[_c('a',{staticClass:"header-anchor",attrs:{"href":"#slave-配置的自动纠正"}},[_vm._v("#")]),_vm._v(" slave 配置的自动纠正")]),_vm._v(" "),_c('p',[_vm._v("哨兵会负责自动纠正 slave 的一些配置，比如 slave 如果要成为潜在的 master 候选人，哨兵会确保 slave 在复制现有 master 的数据; 如果 slave 连接到了一个错误的 master 上，比如故障转移之后，那么哨兵会确保它们连接到正确的 master 上")]),_vm._v(" "),_c('h2',{attrs:{"id":"slave-master-选举算法"}},[_c('a',{staticClass:"header-anchor",attrs:{"href":"#slave-master-选举算法"}},[_vm._v("#")]),_vm._v(" slave->master 选举算法")]),_vm._v(" "),_c('p',[_vm._v("如果一个 master 被认为 odown 了，而且 majority 哨兵都允许了主备切换，那么某个哨兵就会执行主备切换操作，此时首先要选举一个 slave 来")]),_vm._v(" "),_c('p',[_vm._v("会考虑 slave 的一些信息")]),_vm._v(" "),_c('ul',[_c('li',[_vm._v("跟 master 断开连接的时长")]),_vm._v(" "),_c('li',[_vm._v("slave 优先级")]),_vm._v(" "),_c('li',[_vm._v("复制 offset")]),_vm._v(" "),_c('li',[_vm._v("run id")])]),_vm._v(" "),_c('p',[_vm._v("如果一个 slave 跟 master 断开连接已经超过了 down-after-milliseconds的 10 倍，外加 master 宕机的时长，那么 slave 就被认为不适合选举为 master，公式如下")]),_vm._v(" "),_c('div',{staticClass:"language- line-numbers-mode"},[_c('pre',{pre:true,attrs:{"class":"language-text"}},[_c('code',[_vm._v("(down-after-milliseconds * 10) + milliseconds_since_master_is_in_SDOWN_state\n")])]),_vm._v(" "),_c('div',{staticClass:"line-numbers-wrapper"},[_c('span',{staticClass:"line-number"},[_vm._v("1")]),_c('br')])]),_c('p',[_vm._v("接下来会对 slave 进行排序")]),_vm._v(" "),_c('ol',[_c('li',[_vm._v("按照 slave 优先级进行排序，slave priority（redis 配置文件中的属性配置，默认为 100） 越低，优先级就越高")]),_vm._v(" "),_c('li',[_vm._v("如果 slave priority 相同，那么看 replica offset，哪个 slave 复制了越多的数据，offset 越靠后，优先级就越高")]),_vm._v(" "),_c('li',[_vm._v("如果上面两个条件都相同，那么选择一个 run id 比较小的那个 slave")])]),_vm._v(" "),_c('h2',{attrs:{"id":"quorum-和-majority"}},[_c('a',{staticClass:"header-anchor",attrs:{"href":"#quorum-和-majority"}},[_vm._v("#")]),_vm._v(" quorum 和 majority")]),_vm._v(" "),_c('p',[_vm._v("每次一个哨兵要做主备切换，首先需要 quorum 数量的哨兵认为 odown，然后选举出一个哨兵来做切换，这个哨兵还得得到 majority 哨兵的授权，才能正式执行切换")]),_vm._v(" "),_c('p',[_vm._v("如果 quorum < majority，比如 5 个哨兵，majority=3，quorum=2，那么就 3 个哨兵授权就可以执行切换")]),_vm._v(" "),_c('p',[_vm._v("但是如果 quorum >= majority，那么必须 quorum 数量的哨兵都授权；比如 5个哨兵，quorum=5，那么必须 5 个哨兵都同意授权，才能执行切换")]),_vm._v(" "),_c('h2',{attrs:{"id":"configuration-epoch"}},[_c('a',{staticClass:"header-anchor",attrs:{"href":"#configuration-epoch"}},[_vm._v("#")]),_vm._v(" configuration epoch")]),_vm._v(" "),_c('p',[_vm._v("哨兵会对一套 redis master+slave 进行监控，有相应的监控的配置")]),_vm._v(" "),_c('p',[_vm._v("执行切换的那个哨兵，会从要切换到的新 master（salve->master）那里得到一个 configuration epoch，这就是一个 version 号，每次切换的 version 号都必须是唯一的")]),_vm._v(" "),_c('p',[_vm._v("如果第一个选举出的哨兵切换失败了，那么其他哨兵，会等待 failover-timeout 时间，然后接替继续执行切换，此时会重新获取一个新的 configuration epoch，作为新的 version 号")]),_vm._v(" "),_c('h2',{attrs:{"id":"configuraiton-传播"}},[_c('a',{staticClass:"header-anchor",attrs:{"href":"#configuraiton-传播"}},[_vm._v("#")]),_vm._v(" configuraiton 传播")]),_vm._v(" "),_c('p',[_vm._v("哨兵完成切换之后，会在自己本地更新生成最新的 master 配置，然后同步给其他的哨兵，就是通过之前说的 pub/sub 消息机制")]),_vm._v(" "),_c('p',[_vm._v("这里之前的 version 号就很重要了，因为各种消息都是通过一个 channel 去发布和监听的，所以一个哨兵完成一次新的切换之后，新的 master 配置是跟着新的 version 号的")]),_vm._v(" "),_c('p',[_vm._v("其他的哨兵都是根据版本号的大小来更新自己的 master 配置的")])])}
var staticRenderFns = []



/***/ })

}]);
//# sourceMappingURL=360.a195d8b6.js.map